# Force Vagrant to use local directories (no sudo, limited disk quota)
ENV['VAGRANT_HOME'] = File.expand_path('./.vagrant.d', __dir__)

# VM Resource Configuration
# Subject requirement: 1 CPU, 512-1024 MB RAM
# Can be increased for testing, but must comply with subject for evaluation
VM_MEMORY = "1024"  # RAM in MB (subject: 512 or 1024)
VM_CPUS = 1         # Number of CPUs (subject: 1)

# Shared VM storage directory at project root (for all parts)
VM_DATA_DIR = File.expand_path('../vm-data', __dir__)

Vagrant.configure("2") do |config|
  BOX = "ubuntu/jammy64"

  # Global defaults
  config.vm.box = BOX
  config.vm.synced_folder ".", "/vagrant", disabled: false

  # K3s Server VM
  config.vm.define "wstyggS" do |node|
    node.vm.hostname = "wstyggS"
    node.vm.network "private_network", ip: "192.168.56.110"
    node.vm.synced_folder "./shared", "/vagrant_shared", create: true, owner: "vagrant", group: "vagrant"

    node.vm.provider "virtualbox" do |vb|
      vb.customize ["setproperty", "machinefolder", VM_DATA_DIR]
      vb.memory = VM_MEMORY
      vb.cpus = VM_CPUS
      vb.name = "p1_wstyggS"
    end

    node.vm.provision "shell",
      path: "scripts/server.sh",
      privileged: true,
      env: {
        "SERVER_IP" => "192.168.56.110",
        "NODE_NAME" => "wstyggS"
      }
  end

  # K3s Worker VM
  config.vm.define "wstyggSW" do |node|
    node.vm.hostname = "wstyggSW"
    node.vm.network "private_network", ip: "192.168.56.111"
    node.vm.synced_folder "./shared", "/vagrant_shared", create: true, owner: "vagrant", group: "vagrant"

    node.vm.provider "virtualbox" do |vb|
      vb.customize ["setproperty", "machinefolder", VM_DATA_DIR]
      vb.memory = VM_MEMORY
      vb.cpus = VM_CPUS
      vb.name = "p1_wstyggSW"
    end

    node.vm.provision "shell",
      path: "scripts/worker.sh",
      privileged: true,
      env: {
        "SERVER_IP" => "192.168.56.110",
        "NODE_IP" => "192.168.56.111",
        "NODE_NAME" => "wstyggSW"
      }
  end
end